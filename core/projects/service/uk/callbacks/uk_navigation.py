from datetime import datetime
import asyncio

from aiogram import Router, F, Bot
from aiogram.enums import ChatType
from aiogram.types import Message, CallbackQuery

from core.callbacks.navigation import query_message_photo
from core.projects.service.uk.database.requests import Database
from core.projects.service.uk.filters.uk_filter import ChatTypeFilter
from core.projects.service.uk.keyboards.builders import uk_menu

router = Router()

db = Database()

ALLOWED_HASHTAGS = {
    '#–∞–≤–∞—Ä–∏—è': '–ê–≤–∞—Ä–∏—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞',
    '#–∂–∞–ª–æ–±–∞': '–ñ–∞–ª–æ–±–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞',
    '#—Ä–µ–º–æ–Ω—Ç': '–†–µ–º–æ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω',
    '#–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ': '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—é',
    '#—É–±–æ—Ä–∫–∞': '–ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ —É–±–æ—Ä–∫–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã'
}


@router.callback_query(F.data == 'uk_main')
async def card_main(query: CallbackQuery, bot: Bot):
    text = (
        f"<b>üè¢ –£–ö/–¢–°–ñ –±–æ—Ç</b>\n\n"
        f"–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏ –≤ —á–∞—Ç-–≥—Ä—É–ø–ø–∞—Ö –£–ö –∏ –¢–°–ñ. –≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç "
        f"–æ–±—ã—á–Ω—ã–µ —á–∞—Ç—ã –≤ –º–æ—â–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –∂–∏—Ç–µ–ª–µ–π. –° –µ–≥–æ –ø–æ–º–æ—â—å—é –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø–æ–¥–∞–≤–∞—Ç—å "
        f"–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –ø—Ä—è–º–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—â–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ö—ç—à—Ç–µ–≥–∏. –ù–∞—à –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π "
        f"–ø—Ä–æ–µ–∫—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∞–≤–∞—Ä–∏—è—Ö, —Ä–µ–º–æ–Ω—Ç–µ, —É–±–æ—Ä–∫–µ –∏ –¥—Ä—É–≥–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö,"
        f"–¥–µ–ª–∞—è –ø—Ä–æ—Ü–µ—Å—Å —É–¥–æ–±–Ω—ã–º –∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–º.\n\n"
        f"–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –≥—Ä—É–ø–ø—É –∏ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö —Ç–∞–∫–∏—Ö –±–æ—Ç–æ–≤ –º–æ–∂–Ω–æ "
        f"–ø–µ—Ä–µ–π–¥—è –ø–æ —Å—Å—ã–ª–∫–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.\n\n"
        f"–í–¥–æ—Ö–Ω–æ–≤–∏—Ç–µ—Å—å –ø—Ä–∏–º–µ—Ä–æ–º –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ—Ç –¥–ª—è –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, —Ä–µ–∞–ª–∏–∑—É—è –ª—é–±—ã–µ –∏–¥–µ–∏ –∏ –∑–∞–¥–∞—á–∏, "
        f"–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è—Å—å —Ç–æ–ª—å–∫–æ –≤–∞—à–µ–π —Ñ–∞–Ω—Ç–∞–∑–∏–µ–π."
    )
    image_path = 'https://botnest.ru/wp-content/uploads/2024/botnest/images/uk_logo.webp'

    await query_message_photo(query, bot, text, image_path, uk_menu)



@router.message(ChatTypeFilter(chat_type=["group", "supergroup"]))
async def handle_group_message(message: Message):
    if message.text.startswith("#"):
        hashtag, *description = message.text.split(maxsplit=1)
        if hashtag not in ALLOWED_HASHTAGS.keys():
            type_message = (
                "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. "
                "–í–æ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ–±—Ä–∞—â–µ–Ω–∏–π:\n\n"
                "#–∞–≤–∞—Ä–∏—è - –¥–ª—è —Å—Ä–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è—Ö –∏ –∞–≤–∞—Ä–∏—è—Ö.\n"
                "#–∂–∞–ª–æ–±–∞ - –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∞ –∫–∞—á–µ—Å—Ç–≤–æ–º —É—Å–ª—É–≥.\n"
                "#—Ä–µ–º–æ–Ω—Ç - –¥–ª—è –∑–∞—è–≤–æ–∫ –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö —Ä–∞–±–æ—Ç.\n"
                "#–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã –£–ö.\n"
                "#—É–±–æ—Ä–∫–∞ - –¥–ª—è –∑–∞–º–µ—á–∞–Ω–∏–π –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–±–æ—Ä–∫–µ."
            )
            error_message = await message.answer(type_message)

            await asyncio.sleep(30)
            await message.delete()
            await error_message.delete()
            return
        if not description:
            no_message = await message.answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏—è.")
            await asyncio.sleep(10)
            await message.delete()
            await no_message.delete()
            return

        description = " ".join(description)
        request_id = await db.add_request(message.from_user.id, description, hashtag[1:])

        # –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ö—ç—à—Ç–µ–≥–æ–º
        response_msg = await message.answer(
            f"<b>–°–æ–∑–¥–∞–Ω–∞ –∑–∞—è–≤–∫–∞ ‚Ññ{request_id}</b>\n"
            f"<b>–¢–∏–ø–æ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:</b> {hashtag[1:]}\n"
            f"<b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {description}\n\n"
            f"–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ –∑–∞—è–≤–∫–µ –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É 85008008080"
        )

        # –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏
        await asyncio.sleep(5)

        # –û—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏
        closing_response = ALLOWED_HASHTAGS[hashtag]
        closing_response_msg = await message.answer(
            f"<b>–ó–∞—è–≤–∫–∞ ‚Ññ{request_id} –∑–∞–∫—Ä—ã—Ç–∞</b>\n"
            f"<b>–¢–∏–ø–æ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:</b> {hashtag[1:]}\n"
            f"<b>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏:</b> {description}\n\n"
            f"<b>–û—Ç–≤–µ—Ç –ø–æ –∑–∞—è–≤–∫–µ:</b> {closing_response}, –≤—Ä–µ–º—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}. "
            f"–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –£–ö BotNest.\n\n–ó–∞–∫–∞–∑–∞—Ç—å –±–æ—Ç–∞ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º: https://t.me/BotNestRu_bot"
        )

        # –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏
        await asyncio.sleep(20)
        await message.delete()
        await response_msg.delete()
        await closing_response_msg.delete()
    else:
        welcome_message = (
            "—á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ö—ç—à—Ç–µ–≥:\n\n"
            "#–∞–≤–∞—Ä–∏—è - –¥–ª—è —Å—Ä–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è—Ö –∏ –∞–≤–∞—Ä–∏—è—Ö.\n"
            "#–∂–∞–ª–æ–±–∞ - –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∞ –∫–∞—á–µ—Å—Ç–≤–æ–º —É—Å–ª—É–≥.\n"
            "#—Ä–µ–º–æ–Ω—Ç - –¥–ª—è –∑–∞—è–≤–æ–∫ –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö —Ä–∞–±–æ—Ç.\n"
            "#–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã –£–ö.\n"
            "#—É–±–æ—Ä–∫–∞ - –¥–ª—è –∑–∞–º–µ—á–∞–Ω–∏–π –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–±–æ—Ä–∫–µ.\n\n"
            f"–ó–∞–∫–∞–∑–∞—Ç—å –±–æ—Ç–∞ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º: https://t.me/BotNestRu_bot"

        )
        new_message = await message.answer(welcome_message)

        await asyncio.sleep(20)
        await message.delete()
        await new_message.delete()